<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Bharat's Wedding Management</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Bharat's Admin Dashboard üëë</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="booking.html">Book Event</a>
      
      <a href="budget.html">Budget</a>
      <a href="admin.html">Admin Panel</a>
      <a href="admin-payments.html">Payments</a>
      <a href="#" onclick="adminLogout(); return false;" style="color: red; font-weight: bold;">Logout</a>
    </nav>
  </header>

  <section>
    <!-- Admin Stats -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
        <div style="font-size: 0.9em; opacity: 0.9;">Total Bookings</div>
        <div style="font-size: 2em; font-weight: bold; margin: 10px 0;" id="adminTotalBookings">0</div>
      </div>
      <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
        <div style="font-size: 0.9em; opacity: 0.9;">Total Revenue</div>
        <div style="font-size: 2em; font-weight: bold; margin: 10px 0;" id="adminTotalRevenue">‚Çπ0</div>
      </div>
      <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
        <div style="font-size: 0.9em; opacity: 0.9;">Paid Bookings</div>
        <div style="font-size: 2em; font-weight: bold; margin: 10px 0;" id="adminPaidBookings">0</div>
      </div>
      <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
        <div style="font-size: 0.9em; opacity: 0.9;">Pending Amount</div>
        <div style="font-size: 2em; font-weight: bold; margin: 10px 0;" id="adminPendingAmount">‚Çπ0</div>
      </div>
    </div>

    <div class="admin-section">
      <h2>Team Management</h2>
      <div class="bulk-add-section">
        <p>Add Team Members</p>
        <textarea id="bulkTeamMembers" rows="5" placeholder="Example:&#10;Rajesh Kumar&#10;Priya Sharma&#10;Amit Patel"></textarea>
        <button id="addBulkMembers">Add All Team Members</button>
      </div>

      <div class="current-team">
        <h3>Current Team Members</h3>
        <div id="teamList" class="team-members-list"></div>
      </div>
    </div>

    <div class="admin-section">
      <h2>All Bookings</h2>
      <div class="bookings-filter">
        <input type="text" id="searchBooking" placeholder="Search by bride or groom name...">
        <button id="clearSearch">Clear Search</button>
      </div>
      <div id="allBookings" class="bookings-list">
        <!-- Bookings will be loaded here -->
      </div>
    </div>

    <div class="admin-section">
      <h2>Event Assignments</h2>
      <div class="assignment-form">
        <div class="form-group">
          <label>Select Booking:</label>
          <select id="bookingSelect">
            <option value="">Select a Booking</option>
          </select>
        </div>
        <div class="form-group">
          <label>Select Event:</label>
          <select id="eventSelect">
            <option value="">Select an Event</option>
          </select>
        </div>
        <div class="form-group">
          <label>Assign To:</label>
          <select id="assignMember">
            <option value="">Select Team Member</option>
          </select>
        </div>
        <button id="assignEvent">Assign Event</button>
      </div>
      <div id="assignedEvents"></div>
    </div>
  </section>

  <style>
    .add-single-member {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .add-single-member input {
      flex: 1;
    }
    
    .bulk-add-section {
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .bookings-filter {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .bookings-filter input {
      flex: 1;
    }
    
    .bookings-list {
      display: grid;
      gap: 15px;
    }
    
    .booking-card {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      position: relative;
    }
    
    .delete-booking {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #ff4081;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    .team-member-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 5px;
    }
    
    .assignment-form {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
  </style>

  <style>
    .team-members-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    
    .team-members-list .team-member {
      background: #fff5f8;
      padding: 10px;
      border-radius: 6px;
      border-left: 3px solid #D4145A;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .team-member .remove-member {
      background: #ff4081;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
    }
    
    .team-member .remove-member:hover {
      background: #d81b60;
    }
    
    .team-setup textarea {
      width: 100%;
      min-height: 100px;
      margin: 10px 0;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .team-setup button {
      background: #D4145A;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    
    .team-setup button:hover {
      background: #FBB03B;
    }
  </style>

  <style>
    .admin-section {
      background: #fff;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .team-setup {
      margin-bottom: 20px;
    }
    textarea {
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .assignment-form {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: 10px;
      align-items: center;
      margin-bottom: 20px;
    }
    #assignedEvents div {
      background: #f8f9fa;
      padding: 10px;
      margin: 5px 0;
      border-radius: 6px;
      border-left: 4px solid #D4145A;
    }
    .pending-booking {
      background: #fff5f8;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      border-left: 4px solid #FBB03B;
    }
    .event-card {
      background: white;
      padding: 10px;
      margin: 5px 0;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
  </style>

  <script src="js/db.js"></script>
  <script src="admin.js"></script>
  <script src="js/auth.js"></script>
  <script>
    // Add quick admin payments link, wallet status and require admin login
    document.addEventListener('DOMContentLoaded', function(){
      const nav = document.querySelector('nav');
      if (nav && !document.getElementById('adminPaymentsLink')) {
        const a = document.createElement('a');
        a.href = 'admin-payments.html';
        a.id = 'adminPaymentsLink';
        a.textContent = 'Admin Payments';
        nav.appendChild(a);
      }
      // show current user status
      if (window.showCurrentUserStatus) showCurrentUserStatus();

      // Enforce admin login for admin sections - show message but do NOT auto-redirect
      const cur = JSON.parse(localStorage.getItem('currentUser')) || null;
      if (!cur || cur.role !== 'admin') {
        // hide admin sections and show notice
        document.querySelectorAll('.admin-section').forEach(el => el.style.display = 'none');
        const section = document.querySelector('section');
        if (section) {
          const notice = document.createElement('div');
          notice.className = 'card';
          notice.innerHTML = `<h2>‚ö†Ô∏è Admin access required</h2>
            <p>You are logged in as: <strong>${cur ? cur.role : 'guest'}</strong></p>
            <p><a href="login.html">Login with admin account</a> or <a href="#" onclick="DB.logout(); window.location.href='login.html'; return false;" style="color: #d32f2f; font-weight: bold;">switch accounts</a></p>`;
          section.insertBefore(notice, section.firstChild);
        }
      } else {
        // Load admin stats
        loadAdminStats();
      }
    });

    function adminLogout() {
      if (confirm('Are you sure you want to logout?')) {
        DB.logout();
        window.location.href = 'login.html';
      }
    }

    // Load pending member approvals UI
    function renderPendingMembers() {
      const pending = DB.getPendingMembers();
      let html = '';
      if (!pending.length) {
        html = '<p>No pending member approvals</p>';
      } else {
        html = pending.map(m => `
          <div class="team-member" data-id="${m.id}">
            <div>
              <div><strong>${m.name}</strong> (${m.email})</div>
              <div style="font-size:0.9em;color:#666;">Requested salary: ‚Çπ${(m.requestedSalary||0).toLocaleString()}</div>
            </div>
            <div>
              <button onclick="approveMember('${m.id}')" style="margin-right:8px;">Approve</button>
              <button onclick="denyMember('${m.id}')">Deny</button>
            </div>
          </div>
        `).join('');
      }
      const container = document.getElementById('pendingMembersList');
      if (container) container.innerHTML = html;
    }

    // Load admin dashboard stats
    function loadAdminStats() {
      const bookings = DB.getAllBookings();
      const totalBookings = bookings.length;
      const paidBookings = bookings.filter(b => b.paid).length;
      const totalRevenue = bookings.filter(b => b.paid).reduce((sum, b) => sum + (b.totalBudget || 0), 0);
      const pendingAmount = bookings.filter(b => !b.paid).reduce((sum, b) => sum + (b.totalBudget || 0), 0);

      document.getElementById('adminTotalBookings').textContent = totalBookings;
      document.getElementById('adminPaidBookings').textContent = paidBookings;
      document.getElementById('adminTotalRevenue').textContent = '‚Çπ' + totalRevenue.toLocaleString();
      document.getElementById('adminPendingAmount').textContent = '‚Çπ' + pendingAmount.toLocaleString();

      renderAllBookings();
    }

    // Render all bookings for admin view
    function renderAllBookings() {
      const bookings = DB.getAllBookings();
      const container = document.getElementById('allBookings');
      
      if (bookings.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999;">No bookings yet.</p>';
        return;
      }

      container.innerHTML = bookings.map(booking => `
        <div class="booking-card" style="background: ${booking.paid ? '#e8f5e9' : '#fff3e0'}; border-left: 4px solid ${booking.paid ? '#4caf50' : '#ff9800'};">
          <button class="delete-booking" onclick="if(confirm('Delete booking?')) { DB.deleteBooking('${booking.id}'); loadAdminStats(); }">Delete</button>
          <h4 style="margin-top: 0;">${booking.bride} & ${booking.groom}</h4>
          <p>üì± ${booking.mobile} | üìÖ ${new Date(booking.createdAt).toLocaleDateString()}</p>
          <div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 4px;">
            ${booking.events.map(event => `
              <div style="margin: 6px 0; font-size: 0.9em;">
                <strong>${event.functionType}</strong> at ${event.destination} 
                (${event.numGuests} guests, ${event.mealType}, ${event.mealTier})
                ‚Üí ‚Çπ${event.eventBudget.toLocaleString()}
              </div>
            `).join('')}
          </div>
          <div style="font-weight: bold; color: ${booking.paid ? '#2e7d32' : '#e65100'}; font-size: 1.1em;">
            Total: ‚Çπ${booking.totalBudget.toLocaleString()} ${booking.paid ? '‚úì PAID' : '‚è≥ PENDING'}
          </div>
        </div>
      `).join('');
    }

    window.approveMember = function(id) {
      const salary = prompt('Enter accepted salary for member (‚Çπ). Leave blank to use requested salary:');
      const res = DB.approveMember(id, salary ? Number(salary) : undefined);
      if (res.error) return alert(res.error);
      alert('Member approved');
      renderPendingMembers();
      if (window.showCurrentUserStatus) showCurrentUserStatus();
    }

    window.denyMember = function(id) {
      if (!confirm('Deny this member? They will not be able to manage events.')) return;
      const res = DB.denyMember(id);
      if (res.error) return alert(res.error);
      alert('Member denied');
      renderPendingMembers();
      if (window.showCurrentUserStatus) showCurrentUserStatus();
    }

    // create pending members section (below team list)
    const teamDiv = document.querySelector('.current-team');
    if (teamDiv) {
      const pendingSection = document.createElement('div');
      pendingSection.className = 'admin-section';
      pendingSection.innerHTML = `
        <h2>Pending Member Approvals</h2>
        <div id="pendingMembersList">Loading...</div>
      `;
      teamDiv.parentNode.insertBefore(pendingSection, teamDiv.nextSibling);
      renderPendingMembers();
    }
  </script>
</body>
</html>